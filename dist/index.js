import{computed as e,ref as t,defineComponent as l,inject as n,watch as a,resolveComponent as i,resolveDirective as o,openBlock as r,createElementBlock as s,createVNode as d,unref as u,normalizeStyle as c,normalizeClass as v,withCtx as p,withDirectives as m,withModifiers as f,createTextVNode as y,toDisplayString as g,createCommentVNode as h,createBlock as b,pushScopeId as F,popScopeId as _,createElementVNode as w,Fragment as x,renderList as k,toRefs as C,provide as I}from"vue";import{useStores as $,useApi as T,getFieldsFromTemplate as A}from"@directus/extensions-sdk";import{useI18n as S}from"vue-i18n";import{defineStore as P}from"pinia";const V=P("drawerStore",(()=>{const l=t(!1),n=t({create:[],update:[]}),a=t();return{addNewActive:e({get:()=>l.value,set:e=>{e||setTimeout((()=>{a.value=null}),100),l.value=e}}),edits:n,parentId:a,addEdits:function(e){const t=Object.keys(e)[0];n.value[t]||(n.value[t]=[]),n.value[t].push(e[t])}}})),j=e=>(F("data-v-59f65e55"),e=e(),_(),e),B=["data-level"],K={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 320 512",fill:"currentColor"},L=[j((()=>w("path",{d:"M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"},null,-1)))],O={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512",fill:"currentColor",style:{width:"6px",height:"6px"}},N=[j((()=>w("path",{d:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512z"},null,-1)))];var E=l({__name:"ListItem",props:{item:{},templateFields:{},interfaceField:{},level:{}},emits:["input"],setup(l,{emit:F}){const _=l,w=n("collection",t());n("relationInfo",t());const x=n("activeId",t()),k=F,C=$();V();const I=C.usePermissionsStore(),T=t(!0);t({});const A=e((()=>_.templateFields.map((e=>_.item[e])).join(" ")));e((()=>({create:I.hasPermission(w.value,"create"),update:I.hasPermission(w.value,"update")})));const S=e((()=>_.item.id===x.value)),P=e((()=>_.item[_.interfaceField].length>0)),j=()=>{T.value=!T.value};return a((()=>x.value),(()=>{S.value&&(T.value=!0)}),{immediate:!0}),(e,t)=>{const l=i("RouterLink"),n=o("tooltip");return r(),s("li",{"data-level":e.level},[d(l,{to:`/content/${u(w)}/${e.item.id}`,style:c({paddingLeft:14*_.level+4+"px"}),class:v({active:S.value})},{default:p((()=>[m((r(),s("span",{class:v(["icon",{expandable:P.value,open:T.value}]),onClick:f(j,["stop","prevent"])},[P.value?(r(),s("svg",K,L)):(r(),s("svg",O,N))],2)),[[n,P.value?"Apri / Chiudi":null]]),y(" "+g(A.value)+" ",1),h('      <span class="icon on-hover" style="margin-left: 1rem"'),h('            @click.prevent.stop="newChild">'),h("        <v-icon"),h('            v-if="permissions.create"'),h("            v-tooltip=\"'Create new child'\""),h('            class="add"'),h('            name="add"'),h("        />"),h("      </span>")])),_:1},8,["to","style","class"]),P.value?(r(),b(q,{key:0,templateFields:e.templateFields,"interface-field":e.interfaceField,items:e.item[e.interfaceField],level:e.level+1,open:T.value,"onUpdate:modelValue":t[0]||(t[0]=e=>k("input",e))},null,8,["templateFields","interface-field","items","level","open"])):h("v-if",!0)],8,B)}}}),M=[],J=[];function R(e,t){if(e&&"undefined"!=typeof document){var l,n=!0===t.prepend?"prepend":"append",a=!0===t.singleTag,i="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(a){var o=M.indexOf(i);-1===o&&(o=M.push(i)-1,J[o]={}),l=J[o]&&J[o][n]?J[o][n]:J[o][n]=r()}else l=r();65279===e.charCodeAt(0)&&(e=e.substring(1)),l.styleSheet?l.styleSheet.cssText+=e:l.appendChild(document.createTextNode(e))}function r(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var l=Object.keys(t.attributes),a=0;a<l.length;a++)e.setAttribute(l[a],t.attributes[l[a]]);var o="prepend"===n?"afterbegin":"beforeend";return i.insertAdjacentElement(o,e),e}}R("\nli[data-v-59f65e55] {\na[data-v-59f65e55] {\n    display: flex;\n    align-items: center;\n    padding-top: 8px;\n    padding-bottom: 8px;\n    gap: .3rem;\n    border-radius: 4px;\n    transition: background-color .25s ease;\n    color: var(--theme--foreground);\n&[data-v-59f65e55]:hover {\n      background-color: var(--theme--background-accent);\n.icon.on-hover[data-v-59f65e55] {\n        opacity: 1;\n}\n}\n&.active[data-v-59f65e55] {\n      color: var(--theme--foreground-accent);\n      font-weight: bold;\n}\n}\n}\n.icon[data-v-59f65e55] {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 20px;\n  height: 20px;\n  border-radius: 4px;\nsvg[data-v-59f65e55] {\n    width: 12px;\n    height: 12px;\n    transition: transform .25s ease;\n}\n&.expandable[data-v-59f65e55] {\n    transition: background-color .25s ease;\n&[data-v-59f65e55]:hover {\n      background-color: var(--theme--background-subdued);\n}\n&.open svg[data-v-59f65e55] {\n      transform: rotate(90deg);\n}\n}\n&.on-hover[data-v-59f65e55] {\n    opacity: 0;\n    transition: background-color .25s ease, opacity .25s ease-in-out;\n&[data-v-59f65e55]:hover {\n      background-color: var(--theme--background-subdued);\n}\n}\n}\n",{});var z=(e,t)=>{const l=e.__vccOpts||e;for(const[e,n]of t)l[e]=n;return l},H=z(E,[["__scopeId","data-v-59f65e55"],["__file","ListItem.vue"]]),U=l({__name:"List",props:{items:{},templateFields:{},interfaceField:{},level:{},open:{type:Boolean},modelValue:{}},emits:["input","update:modelValue"],setup(l,{emit:n}){const i=l,o=t(),d=n,u=e({get:()=>void 0===i.modelValue?[]:i.modelValue,set:e=>{d("update:modelValue",e)}});return a([()=>i.open,o],(()=>{var e;o&&o.value&&(i.open||null==(e=o.value)||e.style.setProperty("--height",`${o.value.scrollHeight}px`),setTimeout((()=>{var e;null==(e=o.value)||e.style.setProperty("--height",i.open?`${o.value.scrollHeight}px`:"0px")})),i.open&&setTimeout((()=>{var e;null==(e=o.value)||e.style.setProperty("--height",i.open?"auto":"0px")}),410))}),{immediate:!0}),(e,t)=>(r(),s("ul",{class:v({collapsable:e.level>0}),ref_key:"ul",ref:o},[(r(!0),s(x,null,k(e.items,(l=>(r(),b(H,{key:l.id,item:l,templateFields:e.templateFields,interfaceField:e.interfaceField,level:e.level,onInput:t[0]||(t[0]=e=>u.value=e)},null,8,["item","templateFields","interfaceField","level"])))),128))],2))}});R("\nul[data-v-617ca096] {\n  --height: 0px;\n  padding-left: 0;\n  list-style: none;\n  overflow: hidden;\n  transition: height .3s ease-in-out;\n&.collapsable[data-v-617ca096] {\n    height: var(--height);\n}\n}\n",{});var q=z(U,[["__scopeId","data-v-617ca096"],["__file","List.vue"]]);const D={class:"actions"};var G=l({__name:"OneToManyTreeView",props:{value:{},displayTemplate:{default:void 0},disabled:{type:Boolean,default:!1},collection:{},field:{},loading:{type:Boolean},primaryKey:{},enableCreate:{type:Boolean,default:!0},enableSelect:{type:Boolean,default:!0},filter:{default:null}},emits:["input"],setup(l,{emit:o}){const c=l,{collection:v,field:m,primaryKey:f}=C(c),F=T(),_=function(t,l){const{useRelationsStore:n,useCollectionsStore:a,useFieldsStore:i}=$(),o=n(),r=a(),s=i();return{relationInfo:e((()=>{var e,n,a;const i=o.getRelationsForField(t.value,l.value);if(1!==i.length)return;const d=i[0];return{relation:d,relatedCollection:r.getCollection(d.collection),relatedPrimaryKeyField:s.getPrimaryKeyFieldForCollection(d.collection),reverseJunctionField:s.getField(d.collection,null==(e=d.meta)?void 0:e.many_field),sortField:null!=(a=null==(n=d.meta)?void 0:n.sort_field)?a:void 0,type:"o2m"}}))}}(v,m),x=V(),{t:k}=S();n("values",t({}));const P=t({}),j=o;I("collection",c.collection),I("activeId",e((()=>+c.primaryKey))),I("relationInfo",_.relationInfo),e({get:()=>Array.isArray(c.value)?{create:[],update:[],delete:[]}:c.value,set:e=>{emit("input",e)}});const B=t(!1),K=e((()=>{var e,t,l,n;const a=_.relationInfo;return c.displayTemplate||(null==(l=null==(t=null==(e=a.value)?void 0:e.relatedCollection)?void 0:t.meta)?void 0:l.display_template)||`{{${null==(n=a.value)?void 0:n.relatedPrimaryKeyField.field}}}`})),L=e((()=>{var e,l;const n=_.relationInfo;if(!n.value)return[];const a=function(e,l){const{useFieldsStore:n}=$(),a=n();return e.map((e=>{var n,i,o;const r=a.getField(l,e);if(!r)return e;if(null===(null==(n=r.meta)?void 0:n.display))return e;const s=t({fields:[]});if(!s)return e;if(!(null==(i=s.value)?void 0:i.fields))return e;let d=null;return Array.isArray(s.value.fields)&&(d=s.value.fields.map((t=>`${e}.${t}`))),"function"==typeof s.value.fields&&(d=s.value.fields(null==(o=r.meta)?void 0:o.display_options,{collection:r.collection,field:r.field,type:r.type}).map((t=>`${e}.${t}`))),d?d.map((e=>e.includes("$thumbnail")&&"directus_files"===r.collection?e.split(".").filter((e=>"$thumbnail"!==e)).join("."):e)):e})).flat()}(A(K.value),n.value.relatedCollection.collection);return function(e,t){const{useFieldsStore:l}=$();if(!(null==t?void 0:t.length))return[];const n=l(),a=[];for(const l of t){if(a.push(l),!l.includes("."))continue;const t=l.split("."),i=n.getField(e,l);if(!i)continue;const o=n.getPrimaryKeyFieldForCollection(i.collection),r=o&&t.slice(0,-1).concat(o.field).join(".");r&&!a.includes(r)&&a.push(r)}return a}(null!=(l=null==(e=n.value)?void 0:e.relatedCollection.collection)?l:"",a)})),O=async e=>{const t=await F.get(`items/${v.value}/${e}`),l=_.relationInfo.value.relation.field,n=t.data.data;return n[l]?O(n[l]):n},N=async e=>{const t=["*"];for(let e=1;e<=5;e++){const l=[];for(;l.length<e;)l.push(m.value);t.push(`${l.join(".")}.*`)}return(await F.get(`items/${v.value}/${e}`,{params:{fields:t}})).data.data},E=e=>{e[_.relationInfo.value.reverseJunctionField.field]=x.parentId,x.addEdits({create:e}),j("input",x.edits)},M=e=>{x.addNewActive=e};return a((()=>c.primaryKey),(async e=>{if("+"===f.value)return;const t=await O(f.value);P.value=[await N(t.id)]}),{immediate:!0}),a((()=>x.addNewActive),(e=>{B.value=e})),a((()=>c.loading),(e=>{e&&(x.edits={})})),(e,t)=>{const l=i("v-button"),n=i("drawer-item");return r(),s("div",null,[w("div",D,[e.enableCreate?(r(),b(l,{key:0,onClick:M},{default:p((()=>[y(g(u(k)("create_new")),1)])),_:1})):h("v-if",!0)]),d(q,{items:P.value,templateFields:L.value,interfaceField:u(m),level:0},null,8,["items","templateFields","interfaceField"]),d(n,{active:B.value,collection:u(v),"primary-key":"+",edits:{},"circular-field":u(_).relationInfo.value.reverseJunctionField.field,"onUpdate:active":M,onInput:E},null,8,["active","collection","circular-field"])])}}});R("\n.actions[data-v-a1375f14] {\n  margin-bottom: 2rem;\n  margin-top: 1rem;\n}\n",{});var Q={id:"o2m-tree-view",name:"One to Many - Tree View",description:"$t:interfaces.list-o2m-tree-view.description",icon:"account_tree",types:["alias"],localTypes:["o2m"],group:"relational",relational:!0,component:z(G,[["__scopeId","data-v-a1375f14"],["__file","OneToManyTreeView.vue"]]),options:({relations:e})=>{const t=e.o2m?.collection;return[{field:"displayTemplate",name:"$t:display_template",meta:{interface:"system-display-template",options:{collectionName:t},width:"full"}},{field:"enableCreate",name:"$t:creating_items",schema:{default_value:!0},meta:{interface:"boolean",options:{label:"$t:enable_create_button"},width:"half"}}]}};export{Q as default};
